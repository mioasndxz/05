<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AR 정리 도우미 (COCO-SSD)</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ─── 로딩 스크린 스타일 ─── */
    #loadingScreen {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      font-size: 1.4rem;
      font-weight: bold;
      color: #00796b;
    }
    /* ─── 기존 스타일들 ─── */
    body { margin:0; padding:0; font-family:'Noto Sans KR',sans-serif; }
    #video-container { position: relative; width:100%; max-width:640px; padding-top:75%; background:#000; }
    #video,#liveCanvas { position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover; }
    #liveCanvas { z-index:10; pointer-events:none; }
    .button-group { display:flex; justify-content:center; gap:10px; margin:20px;}
    button { padding:10px 20px; font-size:1rem; border:none; border-radius:6px; background:#4a90e2; color:#fff; cursor:pointer;}
    button:disabled { background:#ccc; }
    .modal-overlay { display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);align-items:center;justify-content:center; }
    .modal-content { background:#fff; padding:10px; border-radius:8px; position:relative; }
    .modal-close-btn { position:absolute;top:8px;right:8px;border:none;background:none;font-size:1.5rem;cursor:pointer;color:#888;}
  </style>
</head>
<body>

  <!-- 로딩 스크린 -->
  <div id="loadingScreen">모델 로딩 중… 잠시만 기다려주세요.</div>

  <!-- 비디오 + 캔버스 -->
  <div id="video-container">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="liveCanvas"></canvas>
  </div>

  <!-- 캡처 버튼 -->
  <div class="button-group">
    <button id="captureBtn" disabled>📸 캡처 및 감지</button>
  </div>

  <!-- 결과 모달 -->
  <div id="resultModalOverlay" class="modal-overlay">
    <div class="modal-content">
      <button id="closeModalBtn" class="modal-close-btn">&times;</button>
      <canvas id="modalCanvas"></canvas>
    </div>
  </div>

  <!-- 스크립트 -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
  <script>
    const loadingScreen   = document.getElementById('loadingScreen');
    const video           = document.getElementById('video');
    const liveCanvas      = document.getElementById('liveCanvas');
    const liveCtx         = liveCanvas.getContext('2d');
    const captureBtn      = document.getElementById('captureBtn');
    const modalOverlay    = document.getElementById('resultModalOverlay');
    const closeModalBtn   = document.getElementById('closeModalBtn');
    const modalCanvas     = document.getElementById('modalCanvas');
    const modalCtx        = modalCanvas.getContext('2d');

    let cocoModel = null;

    async function initCameraAndModel() {
      try {
        // 1) 카메라 초기화
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode:'environment', width:640, height:480 }
        });
        video.srcObject = stream;
        await video.play();

        // 캔버스 사이즈 동기화
        liveCanvas.width  = video.videoWidth;
        liveCanvas.height = video.videoHeight;
        modalCanvas.width  = video.videoWidth;
        modalCanvas.height = video.videoHeight;

        // 2) COCO-SSD 모델 로드
        cocoModel = await cocoSsd.load();
        console.log('✅ COCO-SSD loaded');

        // 3) 준비 끝! 로딩 스크린 숨기고 버튼 활성화
        loadingScreen.style.display = 'none';
        captureBtn.disabled = false;

        // 실시간 감지 시작
        detectLiveObjects();
      } catch (err) {
        console.error(err);
        loadingScreen.textContent = '⚠️ 초기화 오류: ' + err.message;
      }
    }

    async function detectLiveObjects() {
      if (!cocoModel || video.paused || video.ended) {
        requestAnimationFrame(detectLiveObjects);
        return;
      }
      const preds = await cocoModel.detect(video);
      liveCtx.clearRect(0,0, liveCanvas.width, liveCanvas.height);
      preds.forEach(p => {
        const [x,y,w,h] = p.bbox;
        liveCtx.strokeStyle = '#00FF00';
        liveCtx.lineWidth = 2;
        liveCtx.strokeRect(x,y,w,h);
        liveCtx.fillStyle = '#00FF00';
        liveCtx.font = '16px Noto Sans KR';
        liveCtx.fillText(p.class, x, y>16? y-4 : y+16);
      });
      requestAnimationFrame(detectLiveObjects);
    }

    async function analyzeSnapshot() {
      if (!cocoModel) return;
      // 캡처 + 그리기
      modalCtx.clearRect(0,0, modalCanvas.width, modalCanvas.height);
      modalCtx.drawImage(video, 0, 0, modalCanvas.width, modalCanvas.height);
      const preds = await cocoModel.detect(modalCanvas);
      preds.forEach(p => {
        const [x,y,w,h] = p.bbox;
        modalCtx.strokeStyle = '#FF0000';
        modalCtx.lineWidth = 3;
        modalCtx.strokeRect(x,y,w,h);
        modalCtx.fillStyle = '#FF0000';
        modalCtx.font = '18px Noto Sans KR';
        modalCtx.fillText(p.class, x, y>18? y-6 : y+18);
      });
      modalOverlay.style.display = 'flex';
    }

    function closeModal() {
      modalOverlay.style.display = 'none';
    }

    captureBtn.addEventListener('click', analyzeSnapshot);
    closeModalBtn.addEventListener('click', closeModal);

    // 앱 시작
    initCameraAndModel();
  </script>
</body>
</html>
